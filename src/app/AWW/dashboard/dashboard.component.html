<div class="dashboard-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <app-skeleton-loader type="rect" width="100%" height="60px" style="margin-bottom: 1em;"></app-skeleton-loader>
    <app-skeleton-loader type="rect" width="100%" height="300px" style="margin-bottom: 1em;"></app-skeleton-loader>
    <app-skeleton-loader type="rect" width="100%" height="400px"></app-skeleton-loader>
    <p class="loading-text">Loading dashboard data...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading">
    <!-- Header Section -->
    <div class="dashboard-header">
      <div class="main-heading-container">
        <h1 class="heading-heading">
          <!-- <i class="pi pi-chart-bar"></i> -->
          Anganwadi <span class="heading-highlight">Dashboard</span>
        </h1>
        <!-- <p class="dashboard-subtitle" style="color: #6366f1;">Monitor student assessments and progress</p> -->
      </div>
    </div>

    <!-- Static Cards Section -->
    <div class="static-cards-row">
      <!-- Desktop View: 3 separate cards -->
      <div class="desktop-cards">
        <p-card class="stat-card total-students">
          <div class="stat-content">
            <div class="stat-icon">
              <i class="pi pi-users"></i>
            </div>
            <div class="stat-details">
              <h3 class="stat-value">{{ dashboardData.totalStudents }}</h3>
              <p class="stat-label">Total Students</p>
              <!-- <p class="stat-sublabel">Assigned to you</p> -->
            </div>
          </div>
        </p-card>

        <p-card class="stat-card boys-students">
          <div class="stat-content">
            <div class="stat-icon">
              <i class="pi pi-mars"></i>
            </div>
            <div class="stat-details">
              <h3 class="stat-value">{{ dashboardData.genderDistribution.boys }}</h3>
              <p class="stat-label">Boys</p>
              <!-- <p class="stat-sublabel">Male students enrolled</p> -->
            </div>
          </div>
        </p-card>

        <p-card class="stat-card girls-students">
          <div class="stat-content">
            <div class="stat-icon">
              <i class="pi pi-venus"></i>
            </div>
            <div class="stat-details">
              <h3 class="stat-value">{{ dashboardData.genderDistribution.girls }}</h3>
              <p class="stat-label">Girls</p>
              <!-- <p class="stat-sublabel">Female students enrolled</p> -->
            </div>
          </div>
        </p-card>
      </div>

      <!-- Mobile View: Single combined card -->
      <div class="mobile-card">
        <p-card class="stat-card combined-students">
          <div class="stat-content">
            <div class="stat-icon">
              <i class="pi pi-users"></i>
            </div>
            <div class="stat-details">
              <h3 class="stat-value">{{ dashboardData.totalStudents }}</h3>
              <p class="stat-label">Total Students</p>
              <div class="gender-breakdown">
                <div class="gender-item">
                  <i class="pi pi-mars"></i>
                  <span>{{ dashboardData.genderDistribution.boys }} Boys</span>
                </div>
                <div class="gender-item">
                  <i class="pi pi-venus"></i>
                  <span>{{ dashboardData.genderDistribution.girls }} Girls</span>
                </div>
              </div>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Integrated Chart & Filters Section -->
    <div class="chart-section">
      <p-card class="chart-card">
        <!-- Assessment Dashboard Heading -->
        <div class="dashboard-heading-container">
          <h3 class="dashboard-heading">Assessment Dashboard</h3>
        </div>

        <!-- Assessment Progress Section (Independent of filters) -->
        <div class="progress-section-top" *ngIf="!loading">
          <div class="progress-header">
            <h4>Overall Assessment Progress</h4>
            <p>Track completion across all competencies, students, and sessions</p>
          </div>
          
          <div class="progress-content">
            <div class="progress-stats">
              <div class="progress-stat">
                <h5>{{ dashboardData.actualAssessmentsDone }}</h5>
                <p>Assessments Done</p>
              </div>
              <div class="progress-divider">/</div>
              <div class="progress-stat">
                <h5>{{ dashboardData.totalPossibleAssessments }}</h5>
                <p>Total Possible</p>
              </div>
            </div>
            
            <div class="progress-bar-container">
              <p-progressBar 
                [value]="getAssessmentProgress()" 
                [style]="{'height': '10px'}"
                [showValue]="false">
              </p-progressBar>
              <div class="progress-percentage">
                {{ getAssessmentProgress() }}%
              </div>
            </div>
          </div>
        </div>

        <div class="chart-layout">
          <!-- Left Column: Filters and Controls (40%) -->
          <div class="filters-column">
            <!-- Action Buttons -->
            <div class="action-buttons-row">
              <div class="chart-loading" *ngIf="loadingAssessments">
                <i class="pi pi-spin pi-spinner"></i>
                <span>Loading data...</span>
              </div>
              <div class="buttons-container" *ngIf="!loadingAssessments">
                <p-button 
                  icon="pi pi-download" 
                  severity="secondary" 
                  size="small"
                  pTooltip="Export to Excel"
                  (onClick)="exportChartData()">
                </p-button>
                <p-button 
                  icon="pi pi-refresh" 
                  severity="secondary" 
                  size="small"
                  pTooltip="Refresh chart data (F5/Ctrl+R)"
                  [loading]="loading || loadingAssessments"
                  [disabled]="loading || loadingAssessments"
                  (onClick)="onRefreshClick($event)">
                </p-button>
                <p-button 
                  icon="pi pi-expand" 
                  severity="secondary" 
                  size="small"
                  pTooltip="Fullscreen"
                  (onClick)="toggleFullscreen()">
                </p-button>
              </div>
            </div>

            <!-- Filters Stack -->
            <div class="filters-stack">
              <div class="filter-item">
                <label><i class="pi pi-calendar"></i> Sessions</label>
                <app-custom-dropdown
                  #sessionsDropdown
                  [options]="sessionOptions"
                  [(ngModel)]="selectedSessionValues"
                  [multiple]="true"
                  placeholder="Select Session/s"
                  [showClear]="true"
                  icon="pi pi-calendar"
                  (selectionChange)="onSessionChange($event)">
                </app-custom-dropdown>
              </div>
              
              <div class="filter-item">
                <label><i class="pi pi-sitemap"></i> Domain</label>
                <app-custom-dropdown
                  #domainDropdown
                  [options]="domainOptions"
                  [(ngModel)]="selectedDomainValue"
                  [multiple]="false"
                  placeholder="Select Domain"
                  [showClear]="true"
                  icon="pi pi-sitemap"
                  (selectionChange)="onDomainChange($event)">
                </app-custom-dropdown>
              </div>

              <div class="filter-item">
                <label><i class="pi pi-bookmark"></i> Competencies</label>
                <app-custom-dropdown
                  #competenciesDropdown
                  [options]="filteredCompetencyOptions"
                  [(ngModel)]="selectedCompetencyValues"
                  [multiple]="true"
                  placeholder="Select Competencies"
                  [showClear]="true"
                  [disabled]="!selectedDomain"
                  icon="pi pi-bookmark"
                  (selectionChange)="onCompetencyChange($event)">
                </app-custom-dropdown>
              </div>
            </div>

            <!-- Reset Button -->
            <div class="reset-button-container">
              <p-button 
                icon="pi pi-refresh"
                label="Reset Filters"
                severity="secondary"
                size="small"
                pTooltip="Clear all filters"
                (onClick)="resetFilters()">
              </p-button>
            </div>
          </div>

          <!-- Right Column: Chart (60%) -->
          <div class="chart-column">
            <!-- Mobile Portrait Warning -->
            <div class="mobile-portrait-warning" *ngIf="isMobilePortrait">
              <div class="warning-content">
                <i class="pi pi-mobile warning-icon"></i>
                <h3>Rotate Your Device</h3>
                <p>Please rotate your device to landscape mode for a better chart viewing experience.</p>
                <div class="rotation-hint">
                  <i class="pi pi-arrow-right"></i>
                  <span>Turn your phone sideways</span>
                </div>
              </div>
            </div>

            <!-- Chart Container -->
            <div class="chart-container" *ngIf="!loadingAssessments && hasSelections && !isMobilePortrait">
              <div class="chart-and-legend-wrapper">
                <div 
                  #chart
                  class="echarts-container"
                  style="width: 100%; height: 500px;">
                </div>
                
                <!-- Chart Legend -->
                <div class="chart-legend">
                  <div class="legend-section">
                    <h5>Assessment Levels:</h5>
                    <div class="level-items">
                      <div 
                        *ngFor="let level of assessmentLevels; let i = index" 
                        class="level-item"
                        [class.legend-hidden]="hiddenLevels.has(level.value)"
                        (mouseenter)="onLegendHover('level', i, true)"
                        (mouseleave)="onLegendHover('level', i, false)"
                        (click)="onLegendClick('level', level.value)">
                        <div 
                          class="level-indicator"
                          [style.background-color]="level.color">
                        </div>
                        <span>{{ level.label }}</span>
                        <i class="pi pi-eye-slash legend-visibility-icon" *ngIf="hiddenLevels.has(level.value)"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- No Selection State -->
            <div class="no-selection-state" *ngIf="!hasSelections && !loading && !isMobilePortrait">
              <div class="empty-state-content">
                <i class="pi pi-filter empty-state-icon"></i>
                <h3>Select Filters to View Data</h3>
                <p>Choose sessions, domains, and competencies to see assessment results and analytics.</p>
              </div>
            </div>

            <!-- Loading State for Chart -->
            <div class="chart-loading-container" *ngIf="loadingAssessments && hasSelections && !isMobilePortrait">
              <app-skeleton-loader variant="graph"></app-skeleton-loader>
            </div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Assessment Progress Section - REMOVED (merged into chart section) -->
    <!--
    <div class="progress-section" *ngIf="hasSelections">
      <p-card class="progress-card">
        <ng-template pTemplate="header">
          <div class="card-header">
            <h3>Assessment Progress</h3>
            <p class="header-subtitle">Track completion of individual assessments across all selected filters</p>
          </div>
        </ng-template>

        <div class="progress-content">
          <div class="progress-stats">
            <div class="progress-stat">
              <h4>{{ dashboardData.actualAssessmentsDone }}</h4>
              <p>Assessments Done</p>
            </div>
            <div class="progress-divider">/</div>
            <div class="progress-stat">
              <h4>{{ dashboardData.totalPossibleAssessments }}</h4>
              <p>Total Possible</p>
            </div>
          </div>
          
          <div class="progress-bar-container">
            <p-progressBar 
              [value]="getAssessmentProgress()" 
              [style]="{'height': '12px'}"
              [showValue]="false">
            </p-progressBar>
            <div class="progress-percentage">
              {{ getAssessmentProgress() }}%
            </div>
          </div>

          <div class="progress-note">
            <i class="pi pi-info-circle"></i>
            <span>Progress shows assessments completed vs total possible assessments</span>
          </div>
        </div>
      </p-card>
    </div>
    -->

    <!-- No Selection State - REMOVED (moved to chart column) -->
    <!--
    <div class="no-selection-state" *ngIf="!hasSelections && !loading">
      <p-card class="empty-state-card">
        <div class="empty-state-content">
          <i class="pi pi-filter empty-state-icon"></i>
          <h3>Select Filters to View Data</h3>
          <p>Choose sessions, domains, and competencies above to see assessment results and analytics.</p>
        </div>
      </p-card>
    </div>
    -->
  </div>
</div>